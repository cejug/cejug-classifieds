<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="help" name="cejug-classifieds-server">
	<property file="build.properties" />
	<import file="deploy/deploy-targets.xml" />
	<import file="deploy/functional-tests.xml" />

	<path id="jaxws.classpath">
		<pathelement location="${java.home}/../lib/tools.jar" />
		<fileset dir="${jaxws.lib.home}">
			<include name="*.jar" />
			<exclude name="j2ee.jar" />
		</fileset>
		<fileset dir="${project.lib}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<taskdef name="wsimport" classname="com.sun.tools.ws.ant.WsImport">
		<classpath refid="jaxws.classpath" />
	</taskdef>

	<taskdef name="xjc" classname="com.sun.tools.xjc.XJCTask">
		<classpath refid="jaxws.classpath" />
	</taskdef>

	<target name="clean">
		<delete dir="${build.classes.home}" includeEmptyDirs="true" />
		<delete dir="${build.war.home}" includeEmptyDirs="true" />
		<delete dir="${generated.dir}" includeEmptyDirs="true" />
	</target>

	<target name="setup">
		<mkdir dir="${build.classes.home}" />
		<mkdir dir="${build.war.home}" />
		<mkdir dir="${generated.dir}" />
	</target>

	<target name="build-server-wsdl">
		<wsimport debug="true" verbose="${verbose}" keep="true" extension="true" destdir="${generated.dir}" package="${service.wsdl.generated.package}" wsdl="${service.wsdl}" wsdllocation="${service.wsdllocation}">
		</wsimport>
		<javac fork="true" srcdir="${basedir}" destdir="${build.classes.home}" includes="${generated.dir}/**/**,src/**/**">
			<classpath refid="jaxws.classpath" />
		</javac>
		<!--jar destfile="lib/wsdl.generated.jar" basedir="${build.classes.home}" excludes="**/*.java" />
		<delete dir="${generated.dir}" /-->
	</target>

	<target name="create-war">
		<war warfile="${build.war.home}/${ant.project.name}.war" webxml="${basedir}/deploy/web.xml">
			<webinf dir="${basedir}/deploy" includes="sun-jaxws.xml" />
			<webinf dir="${basedir}/deploy" includes="handlers.xml" prefix="WEB-INF/classes" />
			<metainf dir="${basedir}/META-INF" includes="**/**" prefix="WEB-INF/classes"/>
			<zipfileset dir="${contract.folder}" includes="*.wsdl, *.xsd" prefix="WEB-INF/wsdl" />
			<zipfileset dir="${resources.folder}" includes="**/**" prefix="WEB-INF/classes" />
			<zipfileset dir="${config.folder}" includes="**/**" prefix="WEB-INF/classes" />
			<classes dir="${build.classes.home}" />
		</war>
	</target>

	<target name="build-client-wsdl" depends="setup">
		<wsimport debug="true" verbose="${verbose}" keep="true" extension="true" destdir="${generated.dir}" package="${functional.tests.client.generated.package}" wsdl="${functional.tests.wsdllocation}">
		</wsimport>
	</target>

	<target name="client" depends="build-client-wsdl">
		<javac fork="true" srcdir="${basedir}" destdir="${build.classes.home}" includes="${generated.dir}/**/**,src/**/**">
			<classpath refid="jaxws.classpath" />
		</javac>
	</target>

	<target name="help">
		<echo message="server:       Builds and deploy the service endpoint WAR" />
		<echo message="client:       Builds the client" />
		<echo message="run:          Runs the client" />
	</target>

	<target name="server" depends="clean,setup,compile.resources.schema">
		<antcall target="build-server-wsdl" />
		<antcall target="create-war" />
		<antcall target="deploy.automatic" />
	</target>

	<target name="deploy.automatic" if="service.deploy.automatic">
		<antcall target="deploy-appserver" />
		<antcall target="deploy-tomcat" />
	</target>

	<target name="full.build">
		<antcall target="server" />
		<!--waitfor maxwait="3" maxwaitunit="minute" checkevery="500">
			<http url="${functional.tests.wsdllocation}" />
		</waitfor-->
		<sleep seconds="10" />
		<antcall target="client" />
		<antcall target="functional.tests" />
	</target>

	<target name="compile.resources.schema">
		<echo message="Compiling the Classifieds-Server Config Schema..." />
		<xjc schema="${jaxb.config.xsd}" extension="true" classpath="${jaxws.classpath}" destdir="${generated.dir}" package="${jaxb.config.package}" />
		<xjc schema="${jaxb.i18n.xsd}" extension="true" classpath="${jaxws.classpath}" destdir="${generated.dir}" package="${jaxb.i18n.package}" />
		<javac srcdir="${basedir}" destdir="${build.classes.home}" includes="${jaxb.config.dir}/**/**" debug="on" source="1.6" />

		<!--jar destfile="lib/footprint-config.jar" basedir="${generated.dir}" />
		<delete dir="${generated.dir}" /-->
	</target>

	<target name="compile.i18.nkeys">
		<echo message="Compiling the I18N keys XML Schema..." />
		<mkdir dir="${jaxb.classes.dir}" />
		<mkdir dir="${generated.dir}" />
		<xjc schema="${i18n.schema}" extension="true" classpath="${build.dir.classes}" target="${generated.dir}" package="${jaxb.bindingclasses.package}">
			<produces dir="${jaxb.classes.dir}" includes="**/*.java" />
		</xjc>
		<javac srcdir="${generated.dir}" destdir="${generated.dir}" debug="on" source="1.6" />
		<jar destfile="lib/footprint-i18nkeys.jar" basedir="${generated.dir}" excludes="**/*.java" />
		<delete dir="${generated.dir}" />
	</target>
</project>
