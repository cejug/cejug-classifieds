<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="help" name="quality-assurance">
	<property file="build.properties" />
	<property environment="env" />

	<path id="project.classpath">
		<fileset dir="${env.AS_HOME}/lib/">
			<include name="javaee.jar" />
			<include name="appserv-ws.jar" />
		</fileset>
		<fileset dir="${project.lib}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" description="http://findbugs.sourceforge.net/manual/anttask.html">
		<classpath refid="project.classpath" />
	</taskdef>
	<taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask" description="http://pmd.sourceforge.net/ant-task.html">
		<classpath refid="project.classpath" />
	</taskdef>

	<target name="findbugs">
		<findbugs home="${project.lib}/ext/findbugs" output="xml:withMessages" outputFile="${reports.home}/findbugs/findbugs.xml" failOnError="true" effort="max">
			<auxClasspath refid="project.classpath" />
			<sourcePath path="${basedir}/src" />
			<class location="${basedir}/build/classes" />
		</findbugs>
	</target>

	<target name="clean">
		<delete dir="${build.classes.home}" includeEmptyDirs="true" />
		<delete dir="${build.ear.home}" includeEmptyDirs="true" />
		<delete dir="${generated.dir}" includeEmptyDirs="true" />
	</target>
	<target name="setup" depends="clean">
		<mkdir dir="${build.classes.home}" />
		<mkdir dir="${build.ear.home}" />
		<mkdir dir="${build.ear.home}/lib" />
		<mkdir dir="${generated.dir}" />
	</target>

	<target name="help">
		<echo message="Quality Assurance tasks. You can reuse these tasks in your project..." />
		<echo message="Thanks for testing Cejug-Classifieds. Any feedback? dev@cejug-classifieds.dev.java.net" />
	</target>

	<target name="compile.tests">
		<javac srcdir="test/integration" destdir="${build.classes.home}">
			<classpath refid="project.classpath" />
			<include name="**/*.java" />
		</javac>
	</target>

	<path id="tests.classpath">
		<pathelement location="${build.classes.home}" />
		<fileset dir="${project.lib}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- Test -->
	<target name="run.tests" depends="compile.tests">
		<junit fork="yes" haltonfailure="yes" printsummary="no">
			<test name="${test.suite}" todir="${reports.home}/junit" />
			<classpath refid="tests.classpath" />
			<formatter type="xml" />
			<jvmarg value="-Dcom.sun.xml.ws.transport.http.client.HttpTransportPipe.dump=${log}" />
		</junit>
	</target>

	<target name="pmd" description="http://pmd.sourceforge.net/">
		<!-- where the report will be generated -->
		<mkdir dir="${reports.home}/pmd" />
		<pmd rulesetfiles="${project.lib}/ext/pmd/pmd-rules.xml" shortFilenames="true">
			<formatter type="html" toFile="${reports.home}/pmd/pmd_report.html" />
			<formatter type="xml" toFile="${reports.home}/pmd/pmd.xml" />
			<fileset dir="${basedir}/src">
				<include name="**/*.java" />
			</fileset>
			<fileset dir="${basedir}/generated">
				<include name="**/*.java" />
			    <exclude name="*/**/ExceptionInterceptor.java" />
			</fileset>
		</pmd>
	</target>

	<target name="validate.xml.documents" description="check the quality of the XML documents, descriptors and schemas.">
		<xmlvalidate failonerror="yes" lenient="no" warn="yes">
			<fileset dir="${contract.folder}" includes="**/**" />
			<attribute name="http://apache.org/xml/features/nonvalidating/load-dtd-grammar" value="false" />
			<attribute name="http://apache.org/xml/features/validation/dynamic" value="true" />
			<attribute name="http://xml.org/sax/features/validation" value="true" />
			<attribute name="http://apache.org/xml/features/validation/schema" value="true" />
			<attribute name="http://apache.org/xml/features/validation/schema-full-checking" value="true" />
			<attribute name="http://apache.org/xml/features/allow-java-encodings" value="true" />
		</xmlvalidate>

		<!-- http://xerces.apache.org/xerces-j/features.html -->
		<!--schemavalidate failonerror="yes" lenient="no" warn="yes" disabledtd="true" fullchecking="false">
            <fileset dir="${contract.folder}" includes="**/**"/>
        </schemavalidate-->
	</target>

	<!-- dbmonster classpath -->
	<path id="dbmonster.classpath">
		<fileset dir="${project.lib}/ext/dbmonster">
			<include name="*.jar" />
		</fileset>
		<!-- JDBC driver -->
		<fileset dir="${env.AS_HOME}/javadb/lib">
			<include name="derbyclient.jar" />
		</fileset>
	</path>

	<!-- Generates random test data using DBMonster (http://dbmonster.kernelpanic.pl/) -->
	<target name="gendb" description="Produces a large amount of random string in the database tables (http://dbmonster.kernelpanic.pl/)">
		<taskdef name="dbmonster" classname="pl.kernelpanic.dbmonster.ant.DBMonsterTask" classpathref="dbmonster.classpath" />
		<dbmonster config="${project.lib}/ext/dbmonster/dbmonster.properties" verbose="true" schema="${project.lib}/ext/dbmonster/classifieds.xml">
		</dbmonster>
	</target>

	<target name="cpd" description="Copy paste detector (http://pmd.sourceforge.net/)">
		<taskdef name="cpd" classname="net.sourceforge.pmd.cpd.CPDTask">
			<classpath refid="project.classpath" />
		</taskdef>
		<mkdir dir="${reports.home}/cpd" />

		<cpd minimumTokenCount="20" format="xml" outputFile="${reports.home}/cpd/cpd.xml" encoding="UTF-8">
			<fileset dir="${basedir}/src">
				<include name="**/*.java" />
			</fileset>
		</cpd>
		<xslt in="${reports.home}/cpd/cpd.xml" style="${project.lib}/ext/pmd/cpdhtml.xslt" out="${reports.home}/cpd/cpd.html" />
		<!--delete file="${reports.home}/cpd/cpd.xml" /-->
	</target>
	
	<target name="javadoc.with.uml" description="generate javadoc with embedded UML diagrams (http://www.umlgraph.org/).">
		<javadoc destdir="${basedir}/docs/javadoc" useexternalfile="true" packagenames="${doc.packages}" classpathref="project.classpath" windowtitle="${doc.windowtitle}" doctitle="${doc.doctitle}" author="true" version="true" use="true" splitindex="true" bottom="${doc.bottom}" encoding="UTF-8" source="1.6">
			<link href="${doc.j2se}" />
			<link href="${doc.j2ee}" />
			<tag name="todo" scope="all" description="To do:" />
			<fileset dir="${basedir}/generated">
				<include name="**/*.java" />
			</fileset>
			<fileset dir="${basedir}/src">
				<include name="**/*.java" />
			</fileset>
			<doclet name="org.umlgraph.doclet.UmlGraphDoc" path="${basedir}/lib/ext/umlgraph/UmlGraph.jar">
				<param name="-inferrel" />
				<param name="-inferdep" />
				<param name="-useimports" />
				<param name="-inferdepvis" value="public" />
				<param name="-hide" value="java.*" />
				<param name="-collpackages" value="java.util.*" />
				<param name="-qualify" />
				<param name="-postfixpackage" />
				<param name="-nodefontsize" value="9" />
				<param name="-nodefontpackagesize" value="7" />
				<param name="-link" value="http://java.sun.com/javase/6/docs/jdk/api/javadoc/doclet/" />
				<param name="-link" value="${doc.j2se}" />
				<param name="-link" value="${doc.j2ee}" />
			</doclet>
		</javadoc>
	</target>
	
	<path id="i18n.checker.classpath">
		<fileset dir="${project.lib}">
			<include name="**/*.jar" />
		</fileset>
		<dirset dir="${build.classes.home}">
			<include name="**/**" />
		</dirset>
	</path>
	<taskdef name="i18nChecker" classname="net.java.dev.footprint.ant.i18n.I18NChecker">
		<classpath refid="i18n.checker.classpath" />
	</taskdef>
</project>
